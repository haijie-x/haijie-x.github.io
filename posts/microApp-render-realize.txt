1:HL["/_next/static/media/c9a5bc6a7c948fb0-s.p.woff2",{"as":"font","type":"font/woff2"}]
2:HL["/_next/static/css/34c9aa3dac019c99.css",{"as":"style"}]
0:["JXPeZoXc9Nz75w5nwf-9S",[[["",{"children":["posts",{"children":[["slug","microApp-render-realize","c"],{"children":["__PAGE__?{\"slug\":[\"microApp-render-realize\"]}",{}]}]}]},"$undefined","$undefined",true],"$L3",[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/34c9aa3dac019c99.css","precedence":"next"}]],["$L4",["$","meta",null,{"name":"next-size-adjust"}]]]]]]
5:I{"id":"8112","chunks":["553:static/chunks/553-b75a1ab1e88d23c9.js","185:static/chunks/app/layout-ae43402e7109a0fc.js"],"name":"","async":false}
6:I{"id":"9553","chunks":["553:static/chunks/553-b75a1ab1e88d23c9.js","185:static/chunks/app/layout-ae43402e7109a0fc.js"],"name":"","async":false}
7:I{"id":"1588","chunks":["272:static/chunks/webpack-ba6ac5b5713db877.js","417:static/chunks/44856608-9ee913c47fa02561.js","920:static/chunks/920-b802bbbd4288d489.js"],"name":"","async":false}
8:I{"id":"4737","chunks":["272:static/chunks/webpack-ba6ac5b5713db877.js","417:static/chunks/44856608-9ee913c47fa02561.js","920:static/chunks/920-b802bbbd4288d489.js"],"name":"","async":false}
3:[["$","html",null,{"lang":"en","children":[["$","link",null,{"rel":"icon","href":"/logo.svg","type":"image/x-icon"}],["$","title",null,{"children":"Hai"}],["$","body",null,{"className":"antialiased min-h-screen bg-white text-slate-900 __className_a64ecd","children":["$","div",null,{"className":"max-w-2xl mx-auto py-10 px-4","children":[["$","header",null,{"children":["$","div",null,{"className":"flex items-center justify-between","children":[["$","$L5",null,{}],["$","nav",null,{"className":"ml-auto text-sm font-medium space-x-6","children":[["$","$L6",null,{"href":"/","children":"Home"}],["$","$L6",null,{"href":"/about","children":"About"}]]}]]}]}],["$","main",null,{"children":["$","$L7",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"template":["$","$L8",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","childProp":{"current":["$","$L7",null,{"parallelRouterKey":"children","segmentPath":["children","posts","children"],"error":"$undefined","errorStyles":"$undefined","loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"template":["$","$L8",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","childProp":{"current":["$","$L7",null,{"parallelRouterKey":"children","segmentPath":["children","posts","children",["slug","microApp-render-realize","c"],"children"],"error":"$undefined","errorStyles":"$undefined","loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"template":["$","$L8",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","childProp":{"current":["$L9",null],"segment":"__PAGE__?{\"slug\":[\"microApp-render-realize\"]}"},"styles":[]}],"segment":["slug","microApp-render-realize","c"]},"styles":[]}],"segment":"posts"},"styles":[]}]}],["$","footer",null,{"className":"mt-10","children":[["$","hr",null,{"className":"my-4"}],["$","small",null,{"className":"flex justify-between","children":["@ Hai",["$","nav",null,{"className":"underline decoration-1","children":[["$","$L6",null,{"href":"https://github.com/haijie-x","className":"mr-3","children":"github"}],["$","$L6",null,{"href":"https://twitter.com/__haijie","children":"twitter"}]]}]]}]]}]]}]}]]}],null]
4:[["$","meta","0",{"charSet":"utf-8"}],["$","title","1",{"children":"Micro Front-End - MicroApp render realize"}],["$","meta","2",{"name":"description","content":"MicroApp微前端框架渲染挂载实现（WebComponent新特性）"}],["$","meta","3",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
9:["$","article",null,{"className":"py-6 prose dark:prose-invert","children":[["$","h1",null,{"className":"mb-4 break-all","children":"Micro Front-End - MicroApp render realize"}],["$","p",null,{"className":"text-slate-700","children":"MicroApp微前端框架渲染挂载实现（WebComponent新特性）"}],["$","hr",null,{"className":"my-4"}],[["$","p",null,{"children":["关于微前端的不同解决方案总结，可以结合下我之前的文章 ->\n",["$","a",null,{"href":"https://juejin.cn/post/7149531106105098277?share_token=77b5ab8b-e8ba-4538-b983-ad0dd981ef44","children":"👾 浅谈微前端解决方案"}]]}],"\n",["$","h3",null,{"children":"WebComponent 介绍："}],"\n",["$","p",null,{"children":"我们可以通过使用新特性 CustomElement 自定义一个 html 标签，来表示一个原生组件，以此来代替如今框架中 React、vue 中的组件。"}],"\n",["$","h3",null,{"children":"如何使用？"}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"language-js","children":"class microApp extends HTMLElement {\n  constructor() {\n    super()\n  }\n}\n"}]}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"language-js","children":"window.customElements.define(\"micro-app\", microApp)\n"}]}],"\n",["$","p",null,{"children":"这样我们在模板中就可以使用了！"}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"language-js","children":"<micro-app></micro-app>\n"}]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"有意思的是，这个原生组件与我们框架中的组件一样，有着自己的生命周期钩子。"}]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"connectedCallback：当组件被插入到文档中触发，有利于我们进行代码初始化。"}]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"disconnectedCallback：当组件从文档中被移除时触发，有利于我们进行代码清除。"}]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"attributeChangedCallback(attrName, oldVal, newVal)：当组件中设置的响应式数据发生变更时触发，结合 observedAttributes 属性一起使用。"}]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"adoptedCallback：当组件被插入到一个新的文档中触发。"}]}],"\n",["$","p",null,{"children":["$","code",null,{"children":"参考MDN中Document.adoptNode的API介绍。"}]}],"\n",["$","blockquote",null,{"children":["\n",["$","h1",null,{"children":"Document.adoptNode()"}],"\n",["$","p",null,{"children":["从其他的 document 文档中获取一个节点。该节点以及它的子树上的所有节点都会从原文档删除 (如果有这个节点的话), 并且它的",["$","code",null,{"children":"ownerDocument"}],"属性会变成当前的 document 文档。之后你可以把这个节点插入到当前文档中。"]}],"\n"]}],"\n",["$","h4",null,{"children":"步入本文主题：实现一个迷你版的 microApp。"}],"\n",["$","h3",null,{"children":"microApp 核心要点：巧妙利用 CustomElement，使用 htmlEntry+各种隔离机制实现子应用挂载、运行与卸载。"}],"\n",["$","h3",null,{}],"\n",["$","p",null,{"children":"首先我们思考，为什么微前端和 webcomponent 扯上了关系？"}],"\n",["$","p",null,{"children":[["$","strong",null,{"children":"图出自 microApp 官网"}],"\n",["$","img",null,{"src":"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7e0201dfb54d4cf69dc8c4e82a5ec985~tplv-k3u1fbpfcp-watermark.image?","alt":"image.png"}]]}],"\n",["$","p",null,{"children":"可以看到，我们利用了 webcomponent 原生组件特性，来充当一个基座应用与子应用的媒介，因为其具有天然的原生支持，可以直接被注册在基座之中，通信也变得十分轻松，天然的生命周期钩子使得它可以进行子应用不同状态的流转操作。"}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"本文主要实现的是对于子应用的挂载渲染操作，自然使用到的便是 webcomponent 的 connectedCallback 钩子。"}]}],"\n",["$","p",null,{"children":"下面来看具体如何实现，这边我们使用 html 编写基座，vue3 编写子应用。"}],"\n",["$","p",null,{"children":"基座代码如下："}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"language-js","children":"<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>微前端解决方案 -WebComponent</title>\n</head>\n<script src=\"./index.mjs\" type=\"module\"></script>\n<body>\n    <div>微前端解决方案 -WebComponent</div>\n    <div>\n      // active-url 表示子应用激活url\n      <micro-app active-url=\"http://127.0.0.1:8002/\"></micro-app>\n    </div>\n</body>\n</html>\n"}]}],"\n",["$","p",null,{"children":"子应用代码如下："}],"\n",["$","p",null,{"children":"main.js"}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"language-js","children":"import { createApp } from \"vue\"\nimport App from \"./App.vue\"\nimport ElementPlus from \"element-plus\"\nimport \"element-plus/dist/index.css\"\n\ncreateApp(App).use(ElementPlus).mount(\"#app\")\n"}]}],"\n",["$","p",null,{"children":"webpack.config.js"}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"language-js","children":"module.exports = {\n  devServer: {\n    port: 8002,\n    headers: {\n      \"Access-Control-Allow-Origin\": \"*\",\n    },\n  },\n}\n"}]}],"\n",["$","p",null,{"children":"microApp 组件代码："}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"language-js","children":"import { fetchHtml, executeScript } from \"./fetch.mjs\"\n\nclass microApp extends HTMLElement {\n  // 子应用激活url\n  get activeUrl() {\n    return this.getAttribute(\"active-url\")\n  }\n  // 需要被监听的属性放在这里定义\n  static get observedAttributes() {\n    // return ['name']\n  }\n  get container() {\n    return this.shadowRoot\n  }\n  constructor() {\n    super()\n  }\n  // 生命周期钩子： component被插入dom中触发\n  async connectedCallback() {\n    // 注意:getAttribute只能在这时候拿到\n    // this.activeUrl = this.getAttribute(\"active-url\");\n    const temp = await this.load()\n    this.bootstrap(temp)\n    Promise.resolve().then(() => {\n      this.mount()\n    })\n  }\n  // 加载资源\n  async load() {\n    const temp = await fetchHtml(this.activeUrl)\n    return temp\n  }\n  // 初始化子应用\n  bootstrap(temp) {\n    // 创建文档片段插入组件中\n    const template = document.createElement(\"template\")\n    template.innerHTML = temp\n    const fra = document.createDocumentFragment()\n    fra.appendChild(template.content.cloneNode(true))\n    this.appendChild(fra)\n  }\n  // 挂载子应用\n  mount() {\n    // 执行相关script\n    executeScript(document)\n  }\n}\nwindow.customElements.define(\"micro-app\", microApp)\n"}]}],"\n",["$","p",null,{"children":"工具函数："}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"language-js","children":"// 保存script脚本\nconst sourceSet = new Set()\n\n// 封装请求资源\nasync function fetchResource(url) {\n  const res = await fetch(url)\n  // res.text 也是一个promise\n  return res.text()\n}\n\n// 请求html文件\nexport async function fetchHtml(url) {\n  let template = await fetchResource(url)\n  return resolveScript(template, url)\n}\n\n// 对html源码进行处理\nexport function resolveScript(template, activeUrl) {\n  return template\n    .replace(/<head[^>]*>[\\s\\S]*?<\\/head>/i, (match) => {\n      return match\n        .replace(/<head/i, \"<micro-app-head\")\n        .replace(/<\\/head>/i, \"</micro-app-head>\")\n    })\n    .replace(/<body[^>]*>[\\s\\S]*?<\\/body>/i, (match) => {\n      return match\n        .replace(/<body/i, \"<micro-app-body\")\n        .replace(/<\\/body>/i, \"</micro-app-body>\")\n    })\n    .replace(/src=\"(.*?)\"/g, (_, text) => {\n      sourceSet.add(`${activeUrl}${text}`)\n      return `src=\"${activeUrl}${text}\"`\n    })\n    .replace(/href=\"(.*?)\"/g, (_, text) => {\n      return `href=\"${activeUrl}${text}\"`\n    })\n}\n\n// 包装所有script脚本\nfunction getExternalScript() {\n  return Promise.all(Array.from(sourceSet).map((url) => fetchResource(url)))\n}\n\n// 执行脚本\nexport async function executeScript(document) {\n  const scripts = await getExternalScript()\n  scripts.forEach((code) => {\n    ;(function (document) {\n      eval(code)\n    })(document)\n  })\n}\n"}]}],"\n",["$","p",null,{"children":["最终效果如下：\n",["$","img",null,{"src":"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4c171a675b1e497fb956fdcca60fcbf6~tplv-k3u1fbpfcp-watermark.image?","alt":"image.png"}]]}]]]}]
